# 配置参数说明 (Configuration Guide)

本文档说明 strategy.py 中的配置参数及其调优建议。

## 基础配置 (Basic Configuration)

### 回测时间范围
```python
start_date = datetime.date(2020, 1, 1)  # 回测开始日期
end_date = datetime.date(2025, 12, 15)  # 回测结束日期
```

### 调仓频率
```python
investment_horizon = 'M'  # 调仓周期
number_of_periods_per_year = 12  # 每年调仓次数
```

**可选值**:
- `'M'` + `12`: 月度调仓（每月调整一次）
- `'W'` + `52`: 周度调仓（每周调整一次）
- `'D'` + `252`: 日度调仓（每天调整一次）

**建议**: 
- 月度调仓：交易成本较低，适合大部分情况
- 周度调仓：更频繁但交易成本更高
- 不推荐日度调仓：交易成本过高，可能抵消收益

### 文件配置
```python
simulation_file = "L10_temp_fixed_m_basicsrisk.pkl"  # 回测断点文件
model_file = "my_model.pkl"  # 模型保存文件
```

## 模型配置 (Model Configuration)

### 训练数据
```python
TRAINING_YEARS = 4  # 训练数据的历史年数
```

**说明**: 使用 start_date 之前的多少年数据进行训练

**调优建议**:
- `3-5年`: 平衡训练样本数量和数据时效性
- 太少(<3年): 训练样本不足，模型可能欠拟合
- 太多(>5年): 历史数据可能不再有效（市场变化）

### 投资组合
```python
N_STOCKS = 40  # 投资组合中的股票数量
```

**说明**: 选择预测收益最高的前N只股票

**调优建议**:
- `30-50只`: 平衡集中度和分散化
- 太少(<30): 风险过于集中
- 太多(>50): 收益被稀释

## GradientBoosting 超参数 (Hyperparameters)

### 模型复杂度控制

```python
GB_N_ESTIMATORS = 150  # 树的数量
```
**说明**: 更多的树可以学习更复杂的模式
- 增加: 提高学习能力，但增加训练时间和过拟合风险
- 减少: 降低过拟合风险，但可能欠拟合
- **推荐范围**: 100-200

```python
GB_MAX_DEPTH = 5  # 树的最大深度
```
**说明**: 控制单棵树的复杂度
- 增加: 捕捉更复杂的模式，但容易过拟合
- 减少: 降低过拟合，但可能欠拟合
- **推荐范围**: 3-6

### 学习速率

```python
GB_LEARNING_RATE = 0.03  # 学习率
```
**说明**: 每棵树对最终预测的贡献权重
- 较低值(0.01-0.05): 更稳定，泛化能力强，需要更多树
- 较高值(0.1-0.3): 学习快，但可能不稳定
- **推荐**: 0.03，配合150棵树

### 防止过拟合参数

```python
GB_MIN_SAMPLES_SPLIT = 30  # 节点分裂最小样本数
GB_MIN_SAMPLES_LEAF = 15   # 叶节点最小样本数
```
**说明**: 限制树的分裂，防止过拟合
- 增加: 更保守的分裂，降低过拟合
- 减少: 允许更细粒度的分裂，可能过拟合
- **推荐**: 根据训练样本数调整，当前值适合~2000-5000样本

```python
GB_SUBSAMPLE = 0.7  # 样本采样比例
```
**说明**: 每棵树训练时随机采样的样本比例
- 0.5-0.8: 增加随机性，提高泛化能力
- 1.0: 使用全部样本，可能过拟合
- **推荐**: 0.7

```python
GB_MAX_FEATURES = 'sqrt'  # 特征采样策略
```
**说明**: 每次分裂时考虑的特征数量
- `'sqrt'`: 使用√n个特征（n为总特征数）
- `'log2'`: 使用log2(n)个特征
- `None`: 使用所有特征
- **推荐**: 'sqrt'，减少特征相关性影响

### 损失函数

```python
GB_LOSS = 'huber'  # 损失函数类型
GB_ALPHA = 0.9     # Huber损失参数
```
**说明**: 
- `'huber'`: 对异常值鲁棒的损失函数
- `alpha`: 控制Huber损失的分位数阈值
- **替代选项**: 
  - `'squared_error'`: 标准平方损失
  - `'absolute_error'`: 绝对值损失
- **推荐**: 'huber'，金融数据常有异常值

### 随机种子

```python
GB_RANDOM_STATE = 42  # 随机种子
```
**说明**: 确保结果可重复
- 固定值: 每次运行结果相同
- None: 每次运行结果可能不同

## 调优流程建议

### 1. 基础配置
首先确定基础参数：
- investment_horizon: M或W
- TRAINING_YEARS: 3-5
- N_STOCKS: 30-50

### 2. 模型训练
使用默认超参数训练基准模型：
```bash
# 删除旧模型和缓存
rm my_model.pkl L10_temp_fixed_m_basicsrisk.pkl

# 运行策略
python strategy.py
```

### 3. 评估性能
查看信息比率和其他指标

### 4. 超参数调优（如果需要）
按以下顺序调整：

**Step 1: 树的数量和学习率**
- 先固定 learning_rate=0.05
- 增加 n_estimators 直到性能不再提升
- 然后降低 learning_rate，相应增加 n_estimators

**Step 2: 树的复杂度**
- 调整 max_depth (3-6)
- 调整 min_samples_split (20-50)
- 调整 min_samples_leaf (10-20)

**Step 3: 随机性参数**
- 调整 subsample (0.6-0.9)
- 尝试不同的 max_features

**Step 4: 投资组合参数**
- 尝试不同的 N_STOCKS (30-50)
- 评估集中度 vs 分散化的权衡

### 5. 交叉验证
理想情况下，应该对不同时间段进行交叉验证：
- 在不同的 start_date 上测试
- 确保策略在多个时期都有效

## 注意事项

1. **避免过拟合**: 
   - 不要过度优化超参数以适应训练期表现
   - 保持模型简单性
   - 使用多个时期验证

2. **交易成本**:
   - 更频繁的调仓(W vs M)增加成本
   - 更多的股票数量可能增加冲击成本

3. **数据质量**:
   - 确保因子数据质量
   - 处理缺失值和异常值

4. **市场环境变化**:
   - 定期重新训练模型
   - 监控模型性能衰减

## 当前配置的理论依据

当前配置是基于以下考虑选择的：

- **4年训练数据**: 平衡样本量和数据时效性
- **40只股票**: 提供足够分散化，同时保持集中度
- **150棵树 + 0.03学习率**: 充分学习但不过拟合
- **max_depth=5**: 捕捉因子交互但限制复杂度
- **subsample=0.7**: 增加泛化能力
- **Huber损失**: 对金融异常值鲁棒

这些参数经过理论分析和经验选择，但在实际应用中可能需要根据具体表现进行微调。
